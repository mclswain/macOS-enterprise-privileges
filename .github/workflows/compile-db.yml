name: Build PrivilegesCLI and upload binary artifact

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # List all targets/schemes for visibility
      - name: List targets and schemes
        run: xcodebuild -list -project source/Privileges.xcodeproj || true

      # Install xcpretty for nicer logs
      - name: Install xcpretty
        run: gem install xcpretty

      # Build only the CLI target (no asset catalogs)
      - name: Build PrivilegesCLI target
        working-directory: source
        run: |
          set -euo pipefail
          xcodebuild \
            -project Privileges.xcodeproj \
            -target PrivilegesCLI \
            -configuration Release \
            -destination "generic/platform=macOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
          | xcpretty

      # Upload the built binary (and any related outputs) as an artifact
      - name: Upload CLI binary
        uses: actions/upload-artifact@v4
        with:
          name: cli-binary
          path: |
            source/build/Release/PrivilegesCLI
            source/build/Release/PrivilegesCLI.app
            source/build/Release/*
